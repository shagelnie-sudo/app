<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل حساب جديد - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f5f7fa; }
        
        /* تصميم خطوات التسجيل */
        .step {
            width: 40px; height: 40px; border-radius: 50%;
            background-color: #6b7280; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; transition: background-color 0.3s ease;
        }
        .step.active { background-color: #10b981; }
        .step-container { display: flex; justify-content: space-between; margin-bottom: 20px; max-width: 300px; margin-left: auto; margin-right: auto; }

        /* رسائل الخطأ والنجاح */
        .message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; display: none; }
        .success-message { background-color: #dcfce7; color: #065f46; border: 1px solid #065f46; }
        .error-message { background-color: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
        
        /* إطار الخطأ للحقول */
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2; }
        
        /* متطلبات كلمة المرور */
        .password-requirement-item { display: flex; align-items: center; font-size: 0.8rem; color: #6b7280; margin-top: 0.2rem; }
        .password-requirement-item.valid { color: #10b981; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg bg-white rounded-xl shadow-xl p-8">
        <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">إنشاء حساب جديد</h2>
        
        <div class="step-container" id="stepContainer">
            <div class="step active" id="stepIndicator1">1</div>
            <div class="step" id="stepIndicator2">2</div>
            <div class="step" id="stepIndicator3">3</div>
            <div class="step" id="stepIndicator4">4</div>
        </div>

        <div id="formContainer">
            
            <div id="step1" class="form-step">
                <h3 class="text-lg font-bold mb-4 border-b pb-2">1. معلومات الدخول</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الاسم الكامل (ثلاثي)</label>
                        <input type="text" id="name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="الاسم الأول والثاني والثالث">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="name@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                        <div class="relative">
                            <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none pl-10">
                            <i class="far fa-eye absolute left-3 top-3 text-gray-400 cursor-pointer" onclick="togglePass('password')"></i>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-1">
                            <div id="req-len" class="password-requirement-item"><i class="fas fa-circle text-[6px] ml-1"></i> 6 أحرف</div>
                            <div id="req-num" class="password-requirement-item"><i class="fas fa-circle text-[6px] ml-1"></i> رقم واحد</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">تأكيد كلمة المرور</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">نوع الحساب</label>
                        <select id="role" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="" disabled selected>-- اختر النوع --</option>
                            <option value="employee">باحث عن عمل (موظف/عامل)</option>
                            <option value="employer">صاحب عمل / شركة</option>
                        </select>
                    </div>
                </div>
                <button type="button" onclick="goToStep(2)" class="w-full mt-6 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">التالي</button>
            </div>

            <div id="employee-flow" class="hidden">
                <div id="step2-employee" class="form-step hidden">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">2. البيانات الشخصية</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">المسمى الوظيفي</label>
                            <input type="text" id="emp-headline" class="w-full px-4 py-2 border rounded-lg" placeholder="مثال: نجار، محاسب، سائق...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                            <input type="tel" id="emp-phone" class="w-full px-4 py-2 border rounded-lg text-right" placeholder="09xxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">الولاية</label>
                            <select id="emp-state" class="w-full px-4 py-2 border rounded-lg"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">نبذة عنك</label>
                            <textarea id="emp-bio" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep(1)" class="w-1/3 bg-gray-200 text-gray-800 py-2 rounded-lg">السابق</button>
                        <button type="button" onclick="goToStep(3)" class="w-2/3 bg-blue-600 text-white py-2 rounded-lg">التالي</button>
                    </div>
                </div>

                <div id="step3-employee" class="form-step hidden">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">3. المهارات والخبرة</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">المهارات (افصل بينها بفاصلة)</label>
                            <input type="text" id="emp-skills" class="w-full px-4 py-2 border rounded-lg" placeholder="مثال: نجارة، حدادة، قيادة">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">سنوات الخبرة</label>
                            <select id="emp-experience" class="w-full px-4 py-2 border rounded-lg">
                                <option value="مبتدئ">مبتدئ (0-1 سنة)</option>
                                <option value="متوسط">متوسط (2-5 سنوات)</option>
                                <option value="خبير">خبير (5+ سنوات)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep(2)" class="w-1/3 bg-gray-200 text-gray-800 py-2 rounded-lg">السابق</button>
                        <button type="button" onclick="goToStep(4)" class="w-2/3 bg-blue-600 text-white py-2 rounded-lg">التالي</button>
                    </div>
                </div>

                <div id="step4-employee" class="form-step hidden">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">4. الملفات (اختياري)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">صورة شخصية (اختياري)</label>
                            <input type="file" id="emp-photo" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">رابط CV (اختياري)</label>
                            <input type="url" id="emp-cv" class="w-full px-4 py-2 border rounded-lg" placeholder="https://...">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep(3)" class="w-1/3 bg-gray-200 text-gray-800 py-2 rounded-lg">السابق</button>
                        <button type="button" onclick="finishRegistration()" id="btn-submit-emp" class="w-2/3 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">إنشاء الحساب</button>
                    </div>
                </div>
            </div>

            <div id="employer-flow" class="hidden">
                <div id="step2-employer" class="form-step hidden">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">2. بيانات الشركة</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">اسم الشركة / العمل</label>
                            <input type="text" id="comp-name" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">هاتف التواصل</label>
                            <input type="tel" id="comp-phone" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">الولاية</label>
                            <select id="comp-state" class="w-full px-4 py-2 border rounded-lg"></select>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep(1)" class="w-1/3 bg-gray-200 text-gray-800 py-2 rounded-lg">السابق</button>
                        <button type="button" onclick="goToStep(3)" class="w-2/3 bg-blue-600 text-white py-2 rounded-lg">التالي</button>
                    </div>
                </div>

                <div id="step3-employer" class="form-step hidden">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">3. التفاصيل</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">وصف النشاط</label>
                            <textarea id="comp-desc" rows="3" class="w-full px-4 py-2 border rounded-lg"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">نوع العمل</label>
                             <div class="flex flex-col space-y-2">
                                <label class="flex items-center space-x-2 border p-3 rounded cursor-pointer">
                                    <input type="radio" name="comp-type" value="company" checked class="ml-2">
                                    <span>شركة / مؤسسة</span>
                                </label>
                                <label class="flex items-center space-x-2 border p-3 rounded cursor-pointer">
                                    <input type="radio" name="comp-type" value="individual" class="ml-2">
                                    <span>فرد (أبحث عن عامل لمنزلي/مشروعي)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep(2)" class="w-1/3 bg-gray-200 text-gray-800 py-2 rounded-lg">السابق</button>
                        <button type="button" onclick="goToStep(4)" class="w-2/3 bg-blue-600 text-white py-2 rounded-lg">التالي</button>
                    </div>
                </div>

                <div id="step4-employer" class="form-step hidden">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">4. التوثيق (اختياري)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">السجل التجاري (PDF/صورة)</label>
                            <input type="file" id="comp-doc" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">شعار الشركة (Logo)</label>
                            <input type="file" id="comp-logo" accept="image/*" class="w-full px-4 py-2 border rounded-lg">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-6">
                        <button type="button" onclick="goToStep(3)" class="w-1/3 bg-gray-200 text-gray-800 py-2 rounded-lg">السابق</button>
                        <button type="button" onclick="finishRegistration()" id="btn-submit-comp" class="w-2/3 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">إنشاء الحساب</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="messageBox" class="message"></div>
        
        <div class="mt-4 text-center text-sm text-gray-500">
            لديك حساب بالفعل؟ <a href="login.html" class="text-blue-600 font-bold">تسجيل الدخول</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // إعدادات Firebase الخاصة بك
        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.appspot.com",
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819",
          measurementId: "G-98GQGZS09W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // متغيرات الحالة
        let currentStep = 1;
        let selectedRole = '';

        // دوال مساعدة عالمية
        window.togglePass = (id) => {
            const el = document.getElementById(id);
            el.type = el.type === 'password' ? 'text' : 'password';
        };

        // دالة لإظهار الأخطاء
        const showError = (msg) => {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.className = 'message error-message';
            box.style.display = 'block';
        };

        const hideError = () => {
            const box = document.getElementById('messageBox');
            box.style.display = 'none';
        };

        // دالة لإظهار رسالة النجاح
        const showSuccess = (msg) => {
            const box = document.getElementById('messageBox');
            box.textContent = msg;
            box.className = 'message success-message';
            box.style.display = 'block';
        };

        // مراقبة الكتابة لإخفاء الأخطاء فوراً
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', function() {
                // إزالة الإطار الأحمر من الحقل الحالي
                this.classList.remove('input-error');
                // إخفاء رسالة الخطأ العامة
                hideError();
                
                // تحديث حالة كلمة المرور إذا كان الحقل هو الباسورد
                if (this.id === 'password') validatePassRealtime(this.value);
            });
        });

        // التحقق من قوة كلمة المرور
        function validatePassRealtime(pass) {
            const len = pass.length >= 6;
            const num = /[0-9]/.test(pass);
            
            const reqLen = document.getElementById('req-len');
            const reqNum = document.getElementById('req-num');

            if (len) reqLen.classList.add('valid', 'text-green-500'); else reqLen.classList.remove('valid', 'text-green-500');
            if (num) reqNum.classList.add('valid', 'text-green-500'); else reqNum.classList.remove('valid', 'text-green-500');
        }

        // دالة الانتقال بين الخطوات
        window.goToStep = function(step) {
            hideError(); // إخفاء أي خطأ سابق

            // التحقق قبل الانتقال من الخطوة 1
            if (currentStep === 1 && step === 2) {
                const name = document.getElementById('name');
                const email = document.getElementById('email');
                const pass = document.getElementById('password');
                const confirm = document.getElementById('confirmPassword');
                const role = document.getElementById('role');

                let isValid = true;

                // التحقق من الاسم (ليس فارغاً)
                if (!name.value.trim()) { name.classList.add('input-error'); isValid = false; }
                
                // التحقق من الإيميل
                if (!email.value.trim()) { email.classList.add('input-error'); isValid = false; }
                
                // التحقق من الباسورد
                if (pass.value.length < 6) { pass.classList.add('input-error'); showError('كلمة المرور قصيرة'); isValid = false; }
                if (pass.value !== confirm.value) { confirm.classList.add('input-error'); showError('كلمة المرور غير متطابقة'); isValid = false; }
                
                // التحقق من النوع
                if (!role.value) { role.classList.add('input-error'); isValid = false; }

                if (!isValid && !document.getElementById('messageBox').style.display) {
                    showError('يرجى ملء الحقول المطلوبة (المحددة بالأحمر)');
                }
                
                if (!isValid) return; // توقف هنا إذا كان هناك خطأ

                // تحديد المسار بناء على الدور
                selectedRole = role.value;
                document.getElementById('employee-flow').classList.add('hidden');
                document.getElementById('employer-flow').classList.add('hidden');

                if (selectedRole === 'employee') {
                    document.getElementById('employee-flow').classList.remove('hidden');
                } else {
                    document.getElementById('employer-flow').classList.remove('hidden');
                }
            }

            // التحقق قبل الانتقال من خطوة 2 أو 3 (تحقق بسيط للحقول الفارغة المهمة)
            if (step > currentStep) {
                // منطق إضافي للتحقق حسب الحاجة لكل خطوة
                // مثال: إذا كنت في خطوة 2 موظف، تحقق من الهاتف
                if (selectedRole === 'employee' && currentStep === 2) {
                    const phone = document.getElementById('emp-phone');
                    if (!phone.value) { phone.classList.add('input-error'); showError('رقم الهاتف مطلوب'); return; }
                }
                 if (selectedRole === 'employer' && currentStep === 2) {
                    const cName = document.getElementById('comp-name');
                    if (!cName.value) { cName.classList.add('input-error'); showError('اسم الشركة مطلوب'); return; }
                }
            }

            // تنفيذ الانتقال
            document.querySelectorAll('.form-step').forEach(el => el.classList.add('hidden'));
            
            // تحديد الـ ID للخطوة القادمة
            let nextStepId = '';
            if (step === 1) nextStepId = 'step1';
            else nextStepId = `step${step}-${selectedRole}`;

            document.getElementById(nextStepId).classList.remove('hidden');
            
            // تحديث المؤشر العلوي
            document.querySelectorAll('.step').forEach((el, idx) => {
                if (idx + 1 <= step) el.classList.add('active');
                else el.classList.remove('active');
            });

            currentStep = step;
        };

        // دالة التسجيل النهائية
        window.finishRegistration = async function() {
            const btnId = selectedRole === 'employee' ? 'btn-submit-emp' : 'btn-submit-comp';
            const btn = document.getElementById(btnId);
            
            btn.disabled = true;
            btn.innerText = 'جاري الحفظ...';
            hideError();

            try {
                // 1. إنشاء المستخدم
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const name = document.getElementById('name').value;
                
                const userCred = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCred.user;

                // 2. إرسال رابط التوثيق
                await sendEmailVerification(user);

                // 3. رفع الملفات وتجهيز البيانات (حسب الدور)
                let userData = {
                    uid: user.uid,
                    name: name,
                    email: email,
                    role: selectedRole,
                    createdAt: serverTimestamp(),
                    isVerified: false // الافتراضي
                };

                if (selectedRole === 'employee') {
                    // بيانات الموظف
                    const photoFile = document.getElementById('emp-photo').files[0];
                    let photoUrl = '';
                    if (photoFile) {
                        photoUrl = await uploadFile(photoFile, `profiles/${user.uid}`);
                    }

                    userData = {
                        ...userData,
                        headline: document.getElementById('emp-headline').value,
                        phone: document.getElementById('emp-phone').value,
                        state: document.getElementById('emp-state').value,
                        bio: document.getElementById('emp-bio').value,
                        skills: document.getElementById('emp-skills').value.split(','),
                        experience: document.getElementById('emp-experience').value,
                        cvUrl: document.getElementById('emp-cv').value,
                        photoUrl: photoUrl
                    };
                    
                    // حفظ في كولكشن employees
                    await setDoc(doc(db, 'employees', user.uid), userData);

                } else {
                    // بيانات الشركة
                    const logoFile = document.getElementById('comp-logo').files[0];
                    const docFile = document.getElementById('comp-doc').files[0];
                    let logoUrl = '', docUrl = '';
                    
                    if (logoFile) logoUrl = await uploadFile(logoFile, `logos/${user.uid}`);
                    if (docFile) docUrl = await uploadFile(docFile, `docs/${user.uid}`);

                    const compType = document.querySelector('input[name="comp-type"]:checked').value;

                    userData = {
                        ...userData,
                        companyName: document.getElementById('comp-name').value,
                        phone: document.getElementById('comp-phone').value,
                        state: document.getElementById('comp-state').value,
                        description: document.getElementById('comp-desc').value,
                        type: compType,
                        logoUrl: logoUrl,
                        commercialDocUrl: docUrl
                    };

                    // حفظ في كولكشن All_jops (أو employers حسب هيكلتك)
                    await setDoc(doc(db, 'All_jops', user.uid), userData);
                }

                showSuccess('تم إنشاء الحساب بنجاح! تم إرسال رابط تفعيل إلى بريدك.');
                
                setTimeout(() => {
                    window.location.href = selectedRole === 'employee' ? 'profile.html' : 'employer-dashboard.html';
                }, 3000);

            } catch (error) {
                console.error(error);
                let msg = 'حدث خطأ غير متوقع';
                if (error.code === 'auth/email-already-in-use') msg = 'البريد الإلكتروني مسجل مسبقاً';
                if (error.code === 'auth/weak-password') msg = 'كلمة المرور ضعيفة';
                showError(msg);
                btn.disabled = false;
                btn.innerText = 'إنشاء الحساب';
            }
        };

        // دالة رفع الملفات
        async function uploadFile(file, path) {
            const storageRef = ref(storage, path);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        }

        // تعبئة الولايات
        const states = ["الخرطوم", "الجزيرة", "البحر الأحمر", "كسلا", "القضارف", "نهر النيل", "الشمالية", "النيل الأبيض", "سنار", "النيل الأزرق", "شمال كردفان", "جنوب كردفان", "غرب كردفان", "شمال دارفور", "جنوب دارفور", "غرب دارفور", "شرق دارفور", "وسط دارفور"];
        
        const empState = document.getElementById('emp-state');
        const compState = document.getElementById('comp-state');
        
        states.forEach(s => {
            empState.add(new Option(s, s));
            compState.add(new Option(s, s));
        });

    </script>
</body>
</html>
