<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل حساب جديد - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --light: #f9fafb;
            --dark: #1f2937;
            --gray: #6b7280;
        }
        body { font-family: 'Tajawal', sans-serif; background-color: #f5f7fa; }
        .step { width: 40px; height: 40px; border-radius: 50%; background-color: var(--gray); color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold; transition: background-color 0.3s ease; }
        .step.active { background-color: var(--success); }
        .step-container { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .form-card { transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 2px solid transparent; }
        .message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .success-message { background-color: #dcfce7; color: #065f46; }
        .error-message { background-color: #fee2e2; color: #991b1b; }
        .password-requirement-item { display: flex; align-items: center; font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
        .password-requirement-item.valid { color: #10b981; }
        .password-input-wrapper { position: relative; }
        .password-toggle { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6b7280; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">إنشاء حساب جديد</h2>
        
        <div class="step-container" id="stepContainer">
            <div class="step active" id="stepIndicator1">1</div>
            <div class="step" id="stepIndicator2">2</div>
            <div class="step" id="stepIndicator3">3</div>
            <div class="step" id="stepIndicator4">4</div>
            <div class="step hidden" id="stepIndicator5">5</div>
            <div class="step hidden" id="stepIndicator6">6</div>
        </div>

        <form id="unifiedForm">
            <div class="form-card" id="step1">
                <h2 class="text-lg font-bold mb-4">الخطوة 1: بيانات الحساب</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الاسم الثلاثي</label>
                        <input id="name" name="name" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-right" placeholder="أدخل اسمك الثلاثي">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                        <input id="email" name="email" type="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-right" placeholder="mail@example.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                        <div class="password-input-wrapper mt-1">
                            <input id="password" name="password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-right pr-10" placeholder="********">
                            <i class="fas fa-eye password-toggle" id="togglePassword"></i>
                        </div>
                        <div class="password-requirements mt-2" id="passwordRequirements">
                            <div id="min-length" class="password-requirement-item"><i class="fas fa-check-circle ml-2"></i><span>6 أحرف على الأقل</span></div>
                            <div id="has-upper" class="password-requirement-item"><i class="fas fa-check-circle ml-2"></i><span>حرف كبير</span></div>
                            <div id="has-number" class="password-requirement-item"><i class="fas fa-check-circle ml-2"></i><span>رقم واحد</span></div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">تأكيد كلمة المرور</label>
                        <input id="confirmPassword" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-right" placeholder="********">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">نوع الحساب</label>
                        <select id="role" name="role" required class="w-full px-3 py-2 border border-gray-300 rounded-md text-right">
                            <option value="" disabled selected>اختر نوع الحساب</option>
                            <option value="employee">موظف / باحث عن عمل</option>
                            <option value="employer">شركة / صاحب عمل</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="mt-6 w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" id="nextBtn1">التالي</button>
            </div>

            <div class="form-card hidden" id="step2-verification">
                <h2 class="text-lg font-bold mb-4 text-center">الخطوة 2: توثيق البريد</h2>
                <div class="text-center space-y-4">
                    <p>أرسلنا رابط تفعيل إلى: <br><span id="verificationEmailDisplay" class="font-bold text-blue-600"></span></p>
                    <button type="button" class="w-full py-3 bg-green-600 text-white rounded-lg" id="confirmVerificationBtn">تأكيد التوثيق والمتابعة</button>
                    <button type="button" class="text-sm text-blue-600" id="resendVerificationBtn">إعادة إرسال الرابط</button>
                </div>
            </div>

            <div id="employee-steps" class="hidden">
                <div class="form-card hidden" id="step3-employee">
                    <h2 class="text-lg font-bold mb-4">الخطوة 3: البيانات الوظيفية</h2>
                    <input type="text" id="headline" name="headline" placeholder="العنوان الوظيفي (مثال: نجار)" class="w-full mb-4 p-2 border rounded-lg">
                    <textarea id="bio" name="bio" placeholder="نبذة عن خبرتك" class="w-full mb-4 p-2 border rounded-lg" rows="3"></textarea>
                    <input type="tel" id="phone" name="phone" placeholder="رقم الهاتف" class="w-full mb-4 p-2 border rounded-lg">
                    <select id="state" name="state" class="w-full mb-4 p-2 border rounded-lg"><option value="">اختر الولاية</option></select>
                    <div id="cityContainer" class="hidden"><select id="city" class="w-full mb-4 p-2 border rounded-lg"></select></div>
                    <button type="button" class="prev-btn px-4 py-2 bg-gray-200 rounded-lg">السابق</button>
                    <button type="button" class="next-btn px-4 py-2 bg-blue-600 text-white rounded-lg">التالي</button>
                </div>
                <div class="form-card hidden" id="step4-employee">
                    <h2 class="text-lg font-bold mb-4">الخطوة 4: المهارات</h2>
                    <div id="skillsContainer">
                        <div class="flex mb-2"><input type="text" placeholder="مهارة" class="skill-input flex-1 p-2 border rounded-lg"></div>
                    </div>
                    <button type="button" id="addSkill" class="text-blue-600 text-sm mb-4">+ إضافة مهارة</button>
                    <button type="button" class="prev-btn block w-full mb-2 py-2 bg-gray-200 rounded-lg">السابق</button>
                    <button type="button" class="next-btn block w-full py-2 bg-blue-600 text-white rounded-lg">التالي</button>
                </div>
                <div class="form-card hidden" id="step5-employee">
                    <h2 class="text-lg font-bold mb-4">الخطوة الأخيرة: الصور</h2>
                    <label class="block text-sm mb-2">صورة شخصية</label>
                    <input type="file" id="profilePhoto" class="mb-4">
                    <label class="block text-sm mb-2">نماذج أعمال (3 صور)</label>
                    <input type="file" id="previousWorks" multiple class="mb-4">
                    <button type="button" class="prev-btn px-4 py-2 bg-gray-200 rounded-lg">السابق</button>
                    <button type="button" id="finalSubmitEmployee" class="px-4 py-2 bg-green-600 text-white rounded-lg">إنشاء الحساب</button>
                </div>
            </div>

            <div id="employer-steps" class="hidden">
                <div class="form-card hidden" id="step3-employer">
                    <h2 class="text-lg font-bold mb-4">بيانات الشركة</h2>
                    <input type="text" id="companyName" placeholder="اسم الشركة" class="w-full mb-4 p-2 border rounded-lg">
                    <input type="email" id="companyEmail" placeholder="ايميل العمل الرسمي" class="w-full mb-4 p-2 border rounded-lg">
                    <button type="button" class="prev-btn px-4 py-2 bg-gray-200 rounded-lg">السابق</button>
                    <button type="button" class="next-btn px-4 py-2 bg-blue-600 text-white rounded-lg">التالي</button>
                </div>
                <div class="form-card hidden" id="step4-employer">
                    <h2 class="text-lg font-bold mb-4">تفاصيل الموقع</h2>
                    <select id="companyState" class="w-full mb-4 p-2 border rounded-lg"><option value="">اختر الولاية</option></select>
                    <button type="button" class="prev-btn px-4 py-2 bg-gray-200 rounded-lg">السابق</button>
                    <button type="button" class="next-btn px-4 py-2 bg-blue-600 text-white rounded-lg">التالي</button>
                </div>
                <div class="form-card hidden" id="step5-employer">
                    <h2 class="text-lg font-bold mb-4">التوثيق التجاري</h2>
                    <input type="file" id="commercialRegister" class="w-full mb-4">
                    <button type="button" class="prev-btn px-4 py-2 bg-gray-200 rounded-lg">السابق</button>
                    <button type="button" class="next-btn px-4 py-2 bg-blue-600 text-white rounded-lg">التالي</button>
                </div>
                <div class="form-card hidden" id="step6-employer">
                    <h2 class="text-lg font-bold mb-4">تفعيل الحساب</h2>
                    <select id="employerType" class="w-full mb-4 p-2 border rounded-lg">
                        <option value="hiring">شركة توظيف</option>
                        <option value="individual">صاحب عمل فردي</option>
                    </select>
                    <button type="button" id="finalSubmitEmployer" class="w-full py-2 bg-green-600 text-white rounded-lg">إنهاء التسجيل</button>
                </div>
            </div>
        </form>

        <div id="message" class="message hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, reload, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.appspot.com", 
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dbmjg23hl/auto/upload";
        const CLOUDINARY_PRESET = "Companies_emploies";

        let currentStep = 1;
        let userRole = '';

        const sudanLocations = {
            "الخرطوم": ["الخرطوم", "أم درمان", "بحري"],
            "الجزيرة": ["ود مدني", "الحصاحيصا"],
            "البحر الأحمر": ["بورتسودان", "سواكن"]
        };

        // التبديل بين الخطوات
        function showStep(n) {
            document.querySelectorAll('.form-card').forEach(c => c.classList.add('hidden'));
            const flow = userRole === 'employer' ? 'employer' : 'employee';
            
            if(n === 1) document.getElementById('step1').classList.remove('hidden');
            else if(n === 2) document.getElementById('step2-verification').classList.remove('hidden');
            else {
                document.getElementById(`step${n}-${flow}`).classList.remove('hidden');
            }
            currentStep = n;
            updateIndicators();
        }

        function updateIndicators() {
            document.querySelectorAll('.step').forEach((s, i) => {
                s.classList.toggle('active', i < currentStep);
                s.classList.toggle('hidden', i >= (userRole === 'employer' ? 6 : 5) && i > 1);
            });
        }

        // معالجة الخطوة الأولى (Firebase Auth)
        document.getElementById('nextBtn1').onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            userRole = document.getElementById('role').value;

            if(!email || !password || !userRole) return alert("يرجى إكمال البيانات");

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await sendEmailVerification(cred.user);
                document.getElementById('verificationEmailDisplay').textContent = email;
                document.getElementById(userRole + '-steps').classList.remove('hidden');
                showStep(2);
            } catch (e) { alert(e.message); }
        };

        // تأكيد التوثيق
        document.getElementById('confirmVerificationBtn').onclick = async () => {
            await reload(auth.currentUser);
            if(auth.currentUser.emailVerified) showStep(3);
            else alert("يرجى تفعيل الحساب من بريدك أولاً");
        };

        // رفع الملفات لـ Cloudinary
        async function upload(file) {
            if(!file) return "";
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', CLOUDINARY_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: fd });
            const data = await res.json();
            return data.secure_url;
        }

        // الحفظ النهائي للموظف
        document.getElementById('finalSubmitEmployee').onclick = async () => {
            const btn = document.getElementById('finalSubmitEmployee');
            btn.disabled = true; btn.textContent = "جاري الحفظ...";
            
            try {
                const user = auth.currentUser;
                const pic = await upload(document.getElementById('profilePhoto').files[0]);
                
                await setDoc(doc(db, "employees", user.uid), {
                    name: document.getElementById('name').value,
                    role: "employee",
                    headline: document.getElementById('headline').value,
                    phone: document.getElementById('phone').value,
                    profilePic: pic,
                    createdAt: serverTimestamp()
                });
                alert("تم إنشاء الحساب بنجاح");
                window.location.href = "profile.html";
            } catch (e) { alert(e.message); btn.disabled = false; }
        };

        // إدارة المهارات والمواقع (تبسيط)
        document.getElementById('addSkill').onclick = () => {
            const input = '<div class="flex mb-2"><input type="text" placeholder="مهارة" class="skill-input flex-1 p-2 border rounded-lg"></div>';
            document.getElementById('skillsContainer').insertAdjacentHTML('beforeend', input);
        };

        // التنقل (التالي والسابق)
        document.querySelectorAll('.next-btn').forEach(btn => {
            btn.onclick = () => showStep(currentStep + 1);
        });
        document.querySelectorAll('.prev-btn').forEach(btn => {
            btn.onclick = () => showStep(currentStep - 1);
        });

        // تعبئة الولايات
        const stateSelects = [document.getElementById('state'), document.getElementById('companyState')];
        stateSelects.forEach(s => {
            Object.keys(sudanLocations).forEach(loc => {
                s.add(new Option(loc, loc));
            });
        });

        // إظهار وإخفاء كلمة المرور
        document.getElementById('togglePassword').onclick = function() {
            const p = document.getElementById('password');
            p.type = p.type === 'password' ? 'text' : 'password';
            this.classList.toggle('fa-eye-slash');
        };

    </script>
</body>
</html>
