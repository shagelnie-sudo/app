<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الملف الشخصي - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
        
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
        }

        body { 
            font-family: 'Tajawal', sans-serif; 
            background-color: #f8fafc;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid var(--primary); 
            border-radius: 50%;
            width: 50px; height: 50px; 
            animation: spin 1s linear infinite; 
            margin: 50px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .glass-header { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .profile-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .profile-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }

        .cover-pattern {
            background-color: #2563eb;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* تحسينات لحقول الإدخال في وضع التعديل */
        .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.2s;
        }
        .edit-input:focus { border-color: var(--primary); }
    </style>
</head>
<body class="text-gray-800">

    <nav class="glass-header sticky top-0 z-50 border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <h1 class="text-2xl font-black text-gray-900 tracking-tight">شغلني</h1>
                </div>
                <div>
                    <button id="logoutBtn" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen pb-12">
        <div id="loadingIndicator" class="flex flex-col items-center justify-center pt-20">
            <div class="loader"></div>
            <p class="text-gray-500 font-medium mt-4">جاري التحميل...</p>
        </div>

        <div id="profileContent" class="hidden"></div>

        <div id="errorMessage" class="hidden max-w-lg mx-auto mt-10 px-4">
            <div class="bg-white border-r-4 border-red-500 p-6 rounded-lg shadow-lg flex items-start gap-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl pt-1"></i>
                <div>
                    <h3 class="font-bold text-gray-900 text-lg">تنبيه</h3>
                    <p id="errorText" class="text-gray-600 mt-1"></p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.appspot.com", 
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819", 
          measurementId: "G-98GQGZS09W" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const profileContent = document.getElementById('profileContent');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // الدوال العالمية للتحكم في وضع التعديل
        window.toggleEdit = () => {
            document.querySelectorAll('.view-mode').forEach(el => el.classList.toggle('hidden'));
            document.querySelectorAll('.edit-mode').forEach(el => el.classList.toggle('hidden'));
        };

        window.saveChanges = async (uid, type) => {
            const saveBtn = document.getElementById('saveBtn');
            const originalContent = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

            try {
                let updatedData = {};
                if (type === 'employee') {
                    updatedData = {
                        name: document.getElementById('edit-name').value,
                        headline: document.getElementById('edit-headline').value,
                        experience: document.getElementById('edit-experience').value,
                        bio: document.getElementById('edit-bio').value
                    };
                } else {
                    updatedData = {
                        "companyInfo.name": document.getElementById('edit-comp-name').value,
                        "companyInfo.businessType": document.getElementById('edit-comp-type').value,
                        "companyInfo.description": document.getElementById('edit-comp-desc').value
                    };
                }

                const docRef = doc(db, type === 'employee' ? "employees" : "All_jops", uid);
                await updateDoc(docRef, updatedData);
                location.reload();
            } catch (error) {
                console.error("Error:", error);
                alert("حدث خطأ أثناء الحفظ، حاول مرة أخرى.");
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalContent;
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                await fetchUserData(user.uid);
            } else {
                window.location.href = 'login.html'; 
            }
        });

        async function fetchUserData(uid) {
            try {
                const empRef = doc(db, "employees", uid);
                const empSnap = await getDoc(empRef);
                if (empSnap.exists()) {
                    renderEmployeeProfile(empSnap.data(), uid);
                    return;
                }

                const bossRef = doc(db, "All_jops", uid);
                const bossSnap = await getDoc(bossRef);
                if (bossSnap.exists()) {
                    renderEmployerProfile(bossSnap.data(), uid);
                    return;
                }
                showError("لم يتم العثور على الحساب.");
            } catch (e) { showError("خطأ في الاتصال بالخادم."); }
        }

        function renderEmployeeProfile(data, uid) {
            const skillsHtml = data.skills ? data.skills.map(s => `<span class="px-3 py-1.5 rounded-lg text-sm bg-blue-50 text-blue-700 border border-blue-100">${s}</span>`).join('') : '...';
            
            const galleryHtml = data.previousWorksUrls?.map(url => `
                <div class="aspect-square rounded-xl overflow-hidden shadow-sm">
                    <img src="${url}" class="w-full h-full object-cover">
                </div>
            `).join('') || '<p class="text-gray-400">لا يوجد أعمال</p>';

            const html = `
                <div class="relative h-64 sm:h-80 w-full cover-pattern"></div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-24 sm:-mt-32 relative z-10">
                    <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 mb-8 border border-gray-100">
                        <div class="flex flex-col sm:flex-row gap-6">
                            <div class="shrink-0 mx-auto">
                                <img src="${data.profileImageUrl || 'https://via.placeholder.com/150'}" class="w-32 h-32 sm:w-40 sm:h-40 rounded-full border-4 border-white shadow-lg object-cover">
                            </div>
                            <div class="flex-1 text-center sm:text-right">
                                <div class="flex flex-col sm:flex-row justify-between items-start">
                                    <div class="w-full">
                                        <div class="view-mode">
                                            <h1 class="text-3xl font-extrabold text-gray-900">${data.name}</h1>
                                            <p class="text-blue-600 font-medium mb-3">${data.headline || 'مسمى وظيفي'}</p>
                                        </div>
                                        <div class="edit-mode hidden space-y-3 mb-4">
                                            <input id="edit-name" type="text" value="${data.name}" class="edit-input" placeholder="الاسم الكامل">
                                            <input id="edit-headline" type="text" value="${data.headline || ''}" class="edit-input" placeholder="المسمى الوظيفي">
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-4 sm:mt-0 w-full sm:w-auto">
                                        <button onclick="toggleEdit()" class="view-mode w-full sm:w-auto px-6 py-2.5 bg-gray-900 text-white rounded-full hover:bg-gray-800 transition shadow-lg">
                                            <i class="fas fa-edit ml-2"></i>تعديل
                                        </button>
                                        <button id="saveBtn" onclick="saveChanges('${uid}', 'employee')" class="edit-mode hidden w-full sm:w-auto px-6 py-2.5 bg-green-600 text-white rounded-full hover:bg-green-700 transition shadow-lg">
                                            <i class="fas fa-check ml-2"></i>حفظ
                                        </button>
                                        <button onclick="toggleEdit()" class="edit-mode hidden w-full sm:w-auto px-6 py-2.5 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300">
                                            إلغاء
                                        </button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap justify-center sm:justify-start gap-3 mt-4">
                                    <div class="view-mode bg-gray-50 px-3 py-1 rounded-full text-sm border">
                                        <i class="fas fa-briefcase ml-1 text-orange-500"></i> ${data.experience || 'مبتدئ'}
                                    </div>
                                    <div class="edit-mode hidden">
                                        <select id="edit-experience" class="edit-input py-1 text-sm">
                                            <option value="مبتدئ" ${data.experience==='مبتدئ'?'selected':''}>مبتدئ</option>
                                            <option value="متوسط" ${data.experience==='متوسط'?'selected':''}>متوسط</option>
                                            <option value="خبير" ${data.experience==='خبير'?'selected':''}>خبير</option>
                                        </select>
                                    </div>
                                    <div class="bg-gray-50 px-3 py-1 rounded-full text-sm border">
                                        <i class="fas fa-envelope ml-1 text-blue-500"></i> ${data.email}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-8">
                            <div class="bg-white rounded-2xl shadow-sm border p-6 sm:p-8">
                                <h3 class="font-bold text-lg mb-4 border-b pb-2"><i class="fas fa-user-edit ml-2 text-blue-500"></i>نبذة تعريفية</h3>
                                <p class="view-mode text-gray-600 leading-relaxed whitespace-pre-line">${data.bio || 'لا توجد نبذة.'}</p>
                                <textarea id="edit-bio" class="edit-mode hidden edit-input h-40">${data.bio || ''}</textarea>
                            </div>
                            <div class="bg-white rounded-2xl shadow-sm border p-6 sm:p-8">
                                <h3 class="font-bold text-lg mb-6"><i class="fas fa-th ml-2 text-purple-500"></i>معرض الأعمال</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${galleryHtml}</div>
                            </div>
                        </div>
                        <div class="space-y-8">
                            <div class="bg-white rounded-2xl shadow-sm border p-6">
                                <h3 class="font-bold text-lg mb-4 border-b pb-2">المهارات</h3>
                                <div class="flex flex-wrap gap-2">${skillsHtml}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            showContent(html);
        }

        function renderEmployerProfile(data, uid) {
            const info = data.companyInfo || {};
            const html = `
                <div class="relative h-64 sm:h-80 w-full bg-slate-900 cover-pattern opacity-80"></div>
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-24 sm:-mt-32 relative z-10">
                    <div class="bg-white rounded-3xl shadow-xl p-6 sm:p-8 mb-8 border border-gray-100">
                        <div class="flex flex-col sm:flex-row gap-6 items-center">
                            <div class="shrink-0">
                                <img src="${info.logoUrl || 'https://via.placeholder.com/150'}" class="w-32 h-32 rounded-2xl object-contain border p-2 bg-white shadow-md">
                            </div>
                            <div class="flex-1 w-full text-center sm:text-right">
                                <div class="flex flex-col sm:flex-row justify-between items-center">
                                    <div class="w-full">
                                        <div class="view-mode">
                                            <h1 class="text-3xl font-extrabold">${info.name || 'اسم الشركة'}</h1>
                                            <p class="text-slate-500">${info.businessType || 'مجال العمل'}</p>
                                        </div>
                                        <div class="edit-mode hidden space-y-3 mb-4">
                                            <input id="edit-comp-name" type="text" value="${info.name || ''}" class="edit-input">
                                            <input id="edit-comp-type" type="text" value="${info.businessType || ''}" class="edit-input">
                                        </div>
                                    </div>
                                    <div class="flex gap-2 mt-4 sm:mt-0">
                                        <button onclick="toggleEdit()" class="view-mode px-6 py-2 bg-blue-600 text-white rounded-full shadow-lg">تعديل</button>
                                        <button id="saveBtn" onclick="saveChanges('${uid}', 'employer')" class="edit-mode hidden px-6 py-2 bg-green-600 text-white rounded-full shadow-lg">حفظ</button>
                                        <button onclick="toggleEdit()" class="edit-mode hidden px-6 py-2 bg-gray-200 rounded-full">إلغاء</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border p-6 sm:p-8 lg:w-2/3">
                        <h3 class="font-bold text-lg mb-4">عن الشركة</h3>
                        <p class="view-mode text-gray-600 leading-relaxed">${info.description || 'لا يوجد وصف.'}</p>
                        <textarea id="edit-comp-desc" class="edit-mode hidden edit-input h-40">${info.description || ''}</textarea>
                    </div>
                </div>
            `;
            showContent(html);
        }

        function showContent(html) {
            loadingIndicator.classList.add('hidden');
            profileContent.innerHTML = html;
            profileContent.classList.remove('hidden');
        }

        function showError(msg) {
            loadingIndicator.classList.add('hidden');
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = 'login.html');
        });
    </script>
</body>
</html>
