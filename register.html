<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل حساب جديد - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --gray: #6b7280;
        }

        body { font-family: 'Tajawal', sans-serif; background-color: #f5f7fa; }

        .step { width: 40px; height: 40px; border-radius: 50%; background-color: var(--gray); color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold; transition: all 0.3s; }
        .step.active { background-color: var(--success); transform: scale(1.1); }

        .form-card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
        
        /* تنسيق مخصص لحقل الهاتف */
        .iti { width: 100%; direction: ltr; }
        .iti__flag-container { right: auto; left: 0; }
        input[type="tel"] { padding-left: 50px !important; text-align: left; direction: ltr; }

        .password-container { position: relative; }
        .toggle-password { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6b7280; z-index: 10; }

        .message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .success-message { background-color: #dcfce7; color: #065f46; }
        .error-message { background-color: #fee2e2; color: #991b1b; }
        
        .password-requirement-item { display: flex; align-items: center; font-size: 0.875rem; color: #6b7280; margin-top: 0.2rem; }
        .password-requirement-item.valid { color: #10b981; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen py-10">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">إنشاء حساب جديد</h2>
        
        <div class="flex justify-between mb-8" id="stepContainer">
            <div class="step active" id="stepIndicator1">1</div>
            <div class="step" id="stepIndicator2">2</div>
            <div class="step" id="stepIndicator3">3</div>
            <div class="step" id="stepIndicator4">4</div>
            <div class="step hidden" id="stepIndicator5">5</div>
        </div>

        <form id="unifiedForm">
            <div class="form-card" id="step1">
                <h2 class="text-lg font-bold mb-4">الخطوة 1: بيانات الحساب</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">الاسم الثلاثي</label>
                        <input id="name" name="name" type="text" required class="w-full px-3 py-2 border rounded-md focus:ring-blue-500" placeholder="أدخل اسمك الثلاثي">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                        <input id="email" name="email" type="email" required class="w-full px-3 py-2 border rounded-md focus:ring-blue-500" placeholder="example@mail.com">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف</label>
                        <input id="phone" name="phone" type="tel" required class="w-full px-3 py-2 border rounded-md focus:ring-blue-500">
                        <p id="phone-error" class="text-xs text-red-500 mt-1 hidden">رقم الهاتف غير صحيح أو مستخدم مسبقاً</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                        <div class="password-container mt-1">
                            <input id="password" name="password" type="password" required class="w-full px-3 py-2 border rounded-md focus:ring-blue-500" placeholder="••••••••">
                            <i class="fas fa-eye toggle-password" onclick="togglePass('password', this)"></i>
                        </div>
                        <div id="passwordRequirements" class="mt-2 space-y-1">
                            <div id="min-length" class="password-requirement-item"><i class="fas fa-circle text-[8px] ml-2"></i> 6 أحرف</div>
                            <div id="has-upper" class="password-requirement-item"><i class="fas fa-circle text-[8px] ml-2"></i> حرف كبير</div>
                            <div id="has-number" class="password-requirement-item"><i class="fas fa-circle text-[8px] ml-2"></i> رقم واحد</div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">تأكيد كلمة المرور</label>
                        <div class="password-container mt-1">
                            <input id="confirmPassword" name="confirmPassword" type="password" required class="w-full px-3 py-2 border rounded-md focus:ring-blue-500" placeholder="••••••••">
                            <i class="fas fa-eye toggle-password" onclick="togglePass('confirmPassword', this)"></i>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">نوع الحساب</label>
                        <select id="role" name="role" required class="w-full px-3 py-2 border rounded-md focus:ring-blue-500">
                            <option value="" disabled selected>اختر نوع الحساب</option>
                            <option value="employee">موظف (باحث عن عمل)</option>
                            <option value="employer">شركة / صاحب عمل</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="w-full mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" id="nextBtn1">التالي</button>
            </div>

            <div class="employee-steps">
                <div class="form-card hidden" id="step2-employee">
                    <h2 class="text-lg font-bold mb-4">الخطوة 2: البيانات المهنية</h2>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">العنوان الاحترافي</label>
                        <input type="text" id="headline" name="headline" placeholder="مثال: مصمم جرافيك" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">نبذة عنك</label>
                        <textarea id="bio" name="bio" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700">الولاية</label>
                        <select id="state" name="state" class="w-full border rounded-lg px-3 py-2"></select>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" class="w-1/2 px-4 py-2 bg-gray-200 rounded-lg" id="prevBtn2-employee">السابق</button>
                        <button type="button" class="w-1/2 px-4 py-2 bg-blue-600 text-white rounded-lg" id="nextBtn2-employee">التالي</button>
                    </div>
                </div>
                <div class="form-card hidden" id="step3-employee">
                    <h2 class="text-lg font-bold mb-4">الخطوة 3: المهارات</h2>
                    <div id="skillsContainer">
                        <div class="mb-4 flex items-center">
                            <input type="text" name="skills[]" placeholder="مهارة" class="skill-input w-full px-3 py-2 border rounded-lg">
                            <button type="button" class="add-skill-btn mr-2 p-2 bg-blue-100 text-blue-600 rounded-lg"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" class="w-1/2 px-4 py-2 bg-gray-200 rounded-lg" id="prevBtn3-employee">السابق</button>
                        <button type="button" class="w-1/2 px-4 py-2 bg-blue-600 text-white rounded-lg" id="nextBtn3-employee">التالي</button>
                    </div>
                </div>

                <div class="form-card hidden" id="step4-employee">
                    <h2 class="text-lg font-bold mb-4">الخطوة 4: معرض الأعمال</h2>
                    <input type="file" id="previousWorks" name="previousWorks" multiple class="w-full mb-4">
                    <div class="flex gap-2">
                        <button type="button" class="w-1/2 px-4 py-2 bg-gray-200 rounded-lg" id="prevBtn4-employee">السابق</button>
                        <button type="submit" class="w-1/2 px-4 py-2 bg-green-600 text-white rounded-lg" id="submitBtn-employee">إتمام التسجيل</button>
                    </div>
                </div>
            </div>

            <div class="employer-steps">
                <div class="form-card hidden" id="step2-employer">
                    <h2 class="text-lg font-bold mb-4">الخطوة 2: بيانات المنشأة</h2>
                    <input type="text" name="companyName" placeholder="اسم الشركة" class="w-full mb-4 px-3 py-2 border rounded-lg">
                    <input type="text" name="businessType" placeholder="مجال العمل" class="w-full mb-4 px-3 py-2 border rounded-lg">
                    <div class="flex gap-2">
                        <button type="button" class="w-1/2 px-4 py-2 bg-gray-200 rounded-lg" id="prevBtn2-employer">السابق</button>
                        <button type="button" class="w-1/2 px-4 py-2 bg-blue-600 text-white rounded-lg" id="nextBtn2-employer">التالي</button>
                    </div>
                </div>
                </div>
        </form>

        <div id="message" class="message hidden"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // إعدادات Firebase (يرجى التأكد من صحتها)
        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.appspot.com",
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // إعداد حقل الهاتف الدولي
        const phoneInput = document.querySelector("#phone");
        const iti = window.intlTelInput(phoneInput, {
            initialCountry: "sd",
            preferredCountries: ["sd", "sa", "ae", "eg"],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
        });

        // وظيفة إظهار وإخفاء كلمة المرور
        window.togglePass = (id, el) => {
            const input = document.getElementById(id);
            if (input.type === "password") {
                input.type = "text";
                el.classList.replace("fa-eye", "fa-eye-slash");
            } else {
                input.type = "password";
                el.classList.replace("fa-eye-slash", "fa-eye");
            }
        };

        // التحقق من أن رقم الهاتف لم يستخدم من قبل
        async function isPhoneUnique(phoneNumber) {
            const collections = ['employees', 'All_jops'];
            for (const colName of collections) {
                const q = query(collection(db, colName), where("phone", "==", phoneNumber));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) return false;
            }
            return true;
        }

        // منطق التنقل والتحقق
        let currentStep = 1;
        let isEmployerFlow = false;

        document.getElementById('nextBtn1').addEventListener('click', async () => {
            const phoneError = document.getElementById('phone-error');
            phoneError.classList.add('hidden');

            // 1. التحقق من صحة الرقم للهوية المختارة
            if (!iti.isValidNumber()) {
                phoneError.textContent = "رقم الهاتف غير صحيح بالنسبة للدولة المختارة";
                phoneError.classList.remove('hidden');
                return;
            }

            // 2. التحقق من فرادة الرقم في قاعدة البيانات
            const fullNumber = iti.getNumber();
            const unique = await isPhoneUnique(fullNumber);
            if (!unique) {
                phoneError.textContent = "رقم الهاتف هذا مسجل بحساب آخر بالفعل";
                phoneError.classList.remove('hidden');
                return;
            }

            // 3. التحقق من بقية الحقول (الاسم، الايميل، كلمة المرور)
            const password = document.getElementById('password').value;
            const confirm = document.getElementById('confirmPassword').value;
            if (password !== confirm) { alert("كلمات المرور غير متطابقة"); return; }
            if (password.length < 6) { alert("كلمة المرور ضعيفة"); return; }

            // الانتقال للخطوة التالية
            isEmployerFlow = (document.getElementById('role').value === 'employer');
            document.getElementById('step1').classList.add('hidden');
            const nextStepId = isEmployerFlow ? 'step2-employer' : 'step2-employee';
            document.getElementById(nextStepId).classList.remove('hidden');
            currentStep = 2;
            updateIndicators();
        });

        function updateIndicators() {
            document.querySelectorAll('.step').forEach((s, i) => {
                if (i < currentStep) s.classList.add('active');
            });
        }

        // دالة إرسال البيانات النهائية (مثال للموظف)
        document.getElementById('submitBtn-employee').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const res = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "employees", res.user.uid), {
                    name: document.getElementById('name').value,
                    phone: iti.getNumber(), // تخزين الرقم الدولي الكامل
                    countryCode: iti.getSelectedCountryData().iso2,
                    role: "employee",
                    createdAt: serverTimestamp()
                });
                alert("تم التسجيل بنجاح!");
                window.location.href = "profile.html";
            } catch (err) {
                alert("خطأ: " + err.message);
            }
        });

        // أزرار الرجوع والتنقل الباقية (مختصرة)
        document.getElementById('prevBtn2-employee').onclick = () => {
            document.getElementById('step2-employee').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            currentStep = 1;
        };
        
    </script>
</body>
</html>
