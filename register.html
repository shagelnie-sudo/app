<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل حساب جديد - شغلني</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        :root { --primary: #2563eb; --primary-dark: #1e40af; --secondary: #f59e0b; --success: #10b981; --danger: #ef4444; --light: #f9fafb; --dark: #1f2937; --gray: #6b7280; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f5f7fa; }
        .step { width: 40px; height: 40px; border-radius: 50%; background-color: var(--gray); color: white; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-weight: bold; transition: background-color 0.3s ease; }
        .step.active { background-color: var(--success); }
        .step-container { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .form-card { transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); border: 2px solid transparent; }
        .image-preview img, .document-preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-left: 8px; }
        .message { text-align: center; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .success-message { background-color: #dcfce7; color: #065f46; }
        .error-message { background-color: #fee2e2; color: #991b1b; }
        .password-requirement-item { display: flex; align-items: center; font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
        .password-requirement-item.valid { color: #10b981; }
        .iti { width: 100%; direction: ltr; }
        .iti__country-list { text-align: left; }
        .password-toggle { cursor: pointer; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #6b7280; }
        
        /* Modal Animation */
        .modal-active { overflow: hidden; }
        #verificationModal { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">
    
    <div id="verificationModal" class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-8 text-center animate-in fade-in zoom-in duration-300">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-paper-plane text-3xl"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-800 mb-2">وثّق بريدك الإلكتروني</h3>
            <p class="text-gray-600 mb-8 leading-relaxed">
                لقد أرسلنا رابط تفعيل إلى بريدك. يرجى الضغط عليه لتتمكن من استخدام حسابك.
            </p>
            
            <div class="space-y-4">
                <button id="confirmVerificationBtn" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i>
                    أكدت البريد، تابع التسجيل
                </button>
                
                <div class="flex flex-col gap-2">
                    <button id="resendEmailBtn" class="text-sm text-gray-500 hover:text-blue-600 font-medium transition">
                        لم يصلك الرابط؟ <span class="underline">إعادة إرسال</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 my-10">
        <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-6">إنشاء حساب جديد</h2>
        <div class="step-container" id="stepContainer">
            <div class="step active" id="stepIndicator1">1</div>
            <div class="step" id="stepIndicator2">2</div>
            <div class="step" id="stepIndicator3">3</div>
            <div class="step" id="stepIndicator4">4</div>
            <div class="step hidden" id="stepIndicator5">5</div>
        </div>

        <form id="unifiedForm">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card" id="step1">
                <h2 class="text-lg font-bold mb-4">الخطوة 1: بيانات الحساب</h2>
                <div class="space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">الاسم الثلاثي</label>
                        <div class="mt-1 text-left">
                            <input id="name" name="name" type="text" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-right">
                        </div>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">البريد الإلكتروني</label>
                        <div class="mt-1">
                            <input id="email" name="email" type="email" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-right">
                        </div>
                    </div>
                    <div>
                        <label for="mainPhone" class="block text-sm font-medium text-gray-700">رقم الهاتف</label>
                        <div class="mt-1">
                            <input id="mainPhone" name="mainPhone" type="tel" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">كلمة المرور</label>
                        <div class="mt-1 relative">
                            <input id="password" name="password" type="password" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-right">
                            <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('password')"></i>
                        </div>
                        <div class="password-requirements mt-2" id="passwordRequirements">
                            <div id="min-length" class="password-requirement-item"><i class="fas fa-check-circle ml-2 text-red-500"></i><span>6 أحرف على الأقل</span></div>
                            <div id="has-upper" class="password-requirement-item"><i class="fas fa-check-circle ml-2 text-red-500"></i><span>حرف كبير</span></div>
                            <div id="has-lower" class="password-requirement-item"><i class="fas fa-check-circle ml-2 text-red-500"></i><span>حرف صغير</span></div>
                            <div id="has-number" class="password-requirement-item"><i class="fas fa-check-circle ml-2 text-red-500"></i><span>رقم واحد</span></div>
                        </div>
                    </div>
                    <div>
                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">تأكيد كلمة المرور</label>
                        <div class="mt-1 relative">
                            <input id="confirmPassword" name="confirmPassword" type="password" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-right">
                            <i class="fas fa-eye password-toggle" onclick="togglePasswordVisibility('confirmPassword')"></i>
                        </div>
                    </div>
                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-700">نوع الحساب</label>
                        <div class="mt-1 text-left">
                            <select id="role" name="role" required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-right">
                                <option value="" disabled selected>اختر نوع الحساب</option>
                                <option value="employee">موظف</option>
                                <option value="employer">شركة / صاحب عمل</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button type="button" class="mt-6 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 w-full" id="nextBtn1">التالي</button>
            </div>

            <div class="employee-steps">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step2-employee">
                    <h2 class="text-lg font-bold mb-4">بيانات الموظف</h2>
                    <input type="text" id="headline" name="headline" placeholder="العنوان الاحترافي" class="w-full mb-4 pr-4 py-2 border border-gray-300 rounded-lg">
                    <textarea id="bio" name="bio" rows="4" placeholder="نبذة عنك" class="w-full mb-4 pr-4 py-2 border border-gray-300 rounded-lg"></textarea>
                    <input type="file" id="profilePhoto" name="profilePhoto" accept="image/*" class="w-full mb-4 pr-4 py-2 border border-gray-300 rounded-lg">
                    <select id="state" name="state" class="w-full mb-4 border border-gray-300 rounded-lg px-3 py-2"><option value="">اختر ولاية</option></select>
                    <div id="cityContainer" class="hidden"><select id="city" name="city" class="w-full mb-4 border border-gray-300 rounded-lg px-3 py-2"></select></div>
                    <div id="areaContainer" class="hidden"><select id="area" name="area" class="w-full mb-4 border border-gray-300 rounded-lg px-3 py-2"></select></div>
                    <div class="flex gap-2">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(2)">السابق</button>
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" onclick="nextStep(2)">التالي</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step3-employee">
                    <h2 class="text-lg font-bold mb-4">المهارات والخبرة</h2>
                    <div id="skillsContainer"><div class="mb-4 flex"><input type="text" name="skills[]" class="skill-input w-full border border-gray-300 rounded-lg p-2"><button type="button" class="add-skill-btn mr-2 p-2 bg-blue-100 text-blue-600 rounded-lg">+</button></div></div>
                    <select id="experience" name="experience" class="w-full mb-4 border border-gray-300 rounded-lg px-3 py-2"><option value="">مستوى الخبرة</option><option value="مبتدئ">مبتدئ</option><option value="متوسط">متوسط</option><option value="خبير">خبير</option></select>
                    <div class="flex gap-2">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(3)">السابق</button>
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" onclick="nextStep(3)">التالي</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step4-employee">
                    <h2 class="text-lg font-bold mb-4">الأعمال السابقة</h2>
                    <input type="file" id="previousWorks" name="previousWorks" multiple accept="image/*" class="w-full mb-4 pr-4 py-2 border border-gray-300 rounded-lg">
                    <input type="url" id="cvUrl" name="cvUrl" placeholder="رابط CV" class="w-full mb-4 pr-4 py-2 border border-gray-300 rounded-lg">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(4)">السابق</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" id="submitBtn-employee">إنشاء الحساب</button>
                </div>
            </div>

            <div class="employer-steps">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step2-employer">
                    <h2 class="text-lg font-bold mb-4">بيانات الشركة</h2>
                    <input type="text" id="companyName" name="companyName" placeholder="اسم الشركة" class="w-full mb-4 p-2 border border-gray-300 rounded-lg">
                    <input type="email" id="companyEmail" name="companyEmail" placeholder="إيميل الشركة" class="w-full mb-4 p-2 border border-gray-300 rounded-lg">
                    <input type="file" id="companyLogo" name="companyLogo" class="w-full mb-4 p-2 border border-gray-300 rounded-lg">
                    <div class="flex gap-2">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(2)">السابق</button>
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" onclick="nextStep(2)">التالي</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step3-employer">
                    <h2 class="text-lg font-bold mb-4">تفاصيل النشاط</h2>
                    <textarea id="companyDescription" name="companyDescription" rows="4" class="w-full mb-4 p-2 border border-gray-300 rounded-lg"></textarea>
                    <select id="companyState" name="companyState" class="w-full mb-4 border border-gray-300 rounded-lg px-3 py-2"><option value="">اختر ولاية</option></select>
                    <div class="flex gap-2">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(3)">السابق</button>
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" onclick="nextStep(3)">التالي</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step4-employer">
                    <h2 class="text-lg font-bold mb-4">التوثيق</h2>
                    <input type="file" id="companyPhotos" name="companyPhotos" multiple class="w-full mb-4 p-2 border border-gray-300 rounded-lg">
                    <div class="flex gap-2">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(4)">السابق</button>
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" onclick="nextStep(4)">التالي</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6 form-card hidden" id="step5-employer">
                    <h2 class="text-lg font-bold mb-4">تفعيل الحساب</h2>
                    <div class="flex flex-col space-y-4 mb-4">
                        <label><input type="radio" name="employerType" value="hiring" checked> شركة توظيف</label>
                        <label><input type="radio" name="employerType" value="individual"> فرد</label>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg" onclick="prevStep(5)">السابق</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg flex-1" id="submitBtn-employer">إنشاء الحساب</button>
                    </div>
                </div>
            </div>
        </form>

        <div id="message" class="message hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBsIaCjE7QOQ6QkhqhCIMA3sLdMvxBxPHk",
          authDomain: "shaglni-c64c0.firebaseapp.com",
          projectId: "shaglni-c64c0",
          storageBucket: "shaglni-c64c0.appspot.com",
          messagingSenderId: "768887356636",
          appId: "1:768887356636:web:11ec1d6991add3309c8819"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dbmjg23hl/image/upload";
        const CLOUDINARY_UPLOAD_PRESET = "Companies_emploies";

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
            const response = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
            const data = await response.json();
            return data.secure_url;
        }

        // --- وظيفة الحفظ النهائية مع المودال ---
        async function submitForm(event) {
            event.preventDefault();
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'جاري المعالجة...';

            const formInputs = document.getElementById('unifiedForm').elements;
            const email = formInputs['email'].value;
            const password = formInputs['password'].value;
            const role = formInputs['role'].value;

            try {
                // 1. إنشاء المستخدم في Firebase
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // 2. إرسال رابط التوثيق فوراً
                await sendEmailVerification(user);

                // 3. رفع الملفات لـ Cloudinary
                let profileImageUrl = null;
                let previousWorksUrls = [];
                
                if (role === 'employee') {
                    if (formInputs['profilePhoto'].files[0]) profileImageUrl = await uploadFile(formInputs['profilePhoto'].files[0]);
                    const files = formInputs['previousWorks'].files;
                    if (files.length > 0) previousWorksUrls = await Promise.all(Array.from(files).map(f => uploadFile(f)));
                } else {
                    if (formInputs['companyLogo'].files[0]) profileImageUrl = await uploadFile(formInputs['companyLogo'].files[0]);
                }

                // 4. حفظ البيانات في Firestore
                const userData = {
                    uid: user.uid,
                    name: formInputs['name'].value,
                    email: email,
                    role: role,
                    profileImageUrl: profileImageUrl,
                    createdAt: serverTimestamp(),
                    emailVerified: false // سنحدثها لاحقاً
                };

                await setDoc(doc(db, role === 'employee' ? 'employees' : 'All_jops', user.uid), userData);

                // 5. إظهار المودال الجميل
                document.getElementById('verificationModal').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("خطأ: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // مستمعات أزرار المودال
        document.getElementById('resendEmailBtn').addEventListener('click', async () => {
            if (auth.currentUser) {
                await sendEmailVerification(auth.currentUser);
                alert("تم إعادة إرسال الرابط!");
            }
        });

        document.getElementById('confirmVerificationBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            await user.reload();
            if (user.emailVerified) {
                const role = document.getElementById('role').value;
                window.location.href = role === 'employee' ? "profile.html" : "employer-dashboard.html";
            } else {
                alert("يرجى تفعيل البريد أولاً من خلال الرابط المرسل إليك.");
            }
        });

        // ربط الدوال بالـ Global Window لتعمل مع الـ HTML
        window.nextStep = nextStep;
        window.prevStep = prevStep;
        document.getElementById('submitBtn-employee').addEventListener('click', submitForm);
        document.getElementById('submitBtn-employer').addEventListener('click', submitForm);

        // --- دوال التنقل (نفس كودك السابق) ---
        let currentStep = 1;
        function nextStep(step) {
            const role = document.getElementById('role').value;
            const currentId = step === 1 ? 'step1' : `step${step}-${role}`;
            const nextId = `step${step+1}-${role}`;
            document.getElementById(currentId).classList.add('hidden');
            document.getElementById(nextId).classList.remove('hidden');
            currentStep++;
            updateStepIndicator();
        }
        function prevStep(step) {
            const role = document.getElementById('role').value;
            const currentId = `step${step}-${role}`;
            const prevId = step === 2 ? 'step1' : `step${step-1}-${role}`;
            document.getElementById(currentId).classList.add('hidden');
            document.getElementById(prevId).classList.remove('hidden');
            currentStep--;
            updateStepIndicator();
        }
        function updateStepIndicator() {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            for(let i=1; i<=currentStep; i++) document.getElementById(`stepIndicator${i}`).classList.add('active');
        }
    </script>
</body>
</html>
